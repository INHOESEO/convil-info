<div id="mainThreedSectionInner">
    <div id="threedElement"></div>
    
    <!-- 기존에 사용하던 로컬 라이브러리 로드 -->
    <script src="./resources/libs/three.js/three.min.r128.js"></script>
    <script src="./resources/libs/three.js/ColladaLoader.r128.js"></script>
    <script src="./resources/libs/three.js/OrbitControls.r128.js"></script>
    
    <script>
        function initThreeScene() {
            console.log('Initializing THREE scene with local libraries');
            const threedElement = document.getElementById('threedElement');
            if (!threedElement) {
                console.error('threedElement not found');
                return;
            }

            // 3D Viewer와 유사한 설정
            threedElement.style.width = '100%';
            threedElement.style.height = '500px';
            threedElement.style.backgroundColor = '#191919';

            const scene = new THREE.Scene();
            scene.background = new THREE.Color(0x191919);

            const camera = new THREE.PerspectiveCamera(
                45,
                threedElement.clientWidth / threedElement.clientHeight,
                0.1,
                2000
            );
            camera.position.set(0, 5, 10);

            const pixelRatio = window.devicePixelRatio || 1;
            const renderer = new THREE.WebGLRenderer({ 
                antialias: true,
                alpha: true
            });
            renderer.setSize(threedElement.clientWidth, threedElement.clientHeight);
            renderer.setPixelRatio(pixelRatio);
            
            // 중요: 색상 인코딩 설정
            if (renderer.outputEncoding !== undefined) {
                renderer.outputEncoding = THREE.sRGBEncoding;
            }
            threedElement.appendChild(renderer.domElement);

            const controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.dampingFactor = 0.05;
            controls.enableZoom = true;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 1.0;

            // 조명 개선
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);

            const directionalLight1 = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight1.position.set(1, 1, 1).normalize();
            scene.add(directionalLight1);

            const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight2.position.set(-1, 0.5, -1).normalize();
            scene.add(directionalLight2);

            // ColladaLoader를 사용하여 모델 로드
            const loader = new THREE.ColladaLoader();
            
            console.log('THREE.js is loaded, ColladaLoader:', loader);
            
            loader.load(
                './source/threed/example3d.dae',
                function(collada) {
                    console.log('Model loaded successfully');
                    const model = collada.scene;
                    
                    // 중요: 재질 보존 - 이전 코드에서 color가 제거되던 부분 수정
                    model.traverse((child) => {
                        if (child.isMesh) {
                            console.log('Mesh found:', child.name);
                            
                            if (child.material) {
                                console.log('Material type:', child.material.type);
                                
                                // 중요: map = null 코드 제거
                                // 대신 재질 업데이트와 양면 렌더링 추가
                                child.material.needsUpdate = true;
                                child.material.side = THREE.DoubleSide;
                                
                                // 재질이 MeshPhongMaterial인 경우 추가 설정
                                if (child.material.type === 'MeshPhongMaterial') {
                                    child.material.shininess = 30;
                                    child.material.specular = new THREE.Color(0x555555);
                                }
                                
                                // 기존 색상 확인
                                if (child.material.color) {
                                    console.log('Material color:', child.material.color.getHexString());
                                }
                            }
                        }
                    });

                    // 모델 크기 및 위치 조정
                    const box = new THREE.Box3().setFromObject(model);
                    const size = box.getSize(new THREE.Vector3());
                    const center = box.getCenter(new THREE.Vector3());

                    const maxDim = Math.max(size.x, size.y, size.z);
                    const scale = 20 / maxDim;
                    model.scale.multiplyScalar(scale);
                    model.position.sub(center.multiplyScalar(scale));
                    
                    scene.add(model);
                    camera.lookAt(model.position);
                },
                function(xhr) {
                    console.log((xhr.loaded / xhr.total * 100) + '% loaded');
                },
                function(error) {
                    console.error('Model load error:', error);
                }
            );

            // 애니메이션 루프
            function animate() {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            }

            // 반응형 처리
            window.addEventListener('resize', function() {
                const width = threedElement.clientWidth;
                const height = threedElement.clientHeight;
                camera.aspect = width / height;
                camera.updateProjectionMatrix();
                renderer.setSize(width, height);
            });

            animate();
        }

        // 페이지 로드 시 초기화
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initThreeScene);
        } else {
            initThreeScene();
        }
    </script>
</div>